<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>View Sites - HS Priat Software</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="auth-guard.js" defer></script>
  <style>
    :root {
        --primary-color: #1abc9c; /* Bright Teal */
        --secondary-color: #95a5a6; /* Cool Silver */
        --sidebar-bg: #34495e;    /* Wet Asphalt */
        --body-bg: #ecf0f1;       /* Clouds */
        --card-bg: #ffffff;
        --font-family: 'Poppins', sans-serif;
    }

    body {
        font-family: var(--font-family);
        background-color: var(--body-bg);
        display: flex;
    }

    .sidebar {
        width: fit-content; /* Adjust width to content */
        min-width: 260px; /* Ensure a minimum width */
        background-color: var(--sidebar-bg);
        color: white;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
    }

    .sidebar .logo {
        font-size: 1.6rem;
        font-weight: bold;
        margin-bottom: 10px;
        text-align: center;
    }

    .sidebar .subtitle {
        font-size: 0.9rem;
        text-align: center;
        margin-bottom: 30px;
        color: #adb5bd;
    }

    .sidebar .menu a {
        color: #dee2e6;
        text-decoration: none;
        padding: 12px 15px;
        display: block;
        border-radius: 5px;
        margin-bottom: 8px;
        transition: background-color 0.3s, color 0.3s;
    }

    .sidebar .menu a i {
        margin-right: 15px;
        width: 20px;
        text-align: center;
    }

    .sidebar .menu a:hover, .sidebar .menu a.active {
        background-color: var(--primary-color);
        color: white;
    }

    .main-content {
        margin-left: 260px;
        padding: 30px;
        width: calc(100% - 260px);
    }

    .comparison-container {
      display: none; /* Initially hidden */
      margin-top: 30px;
      padding: 20px;
      background-color: var(--card-bg);
      border-radius: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .comparison-controls {
      margin-bottom: 20px;
    }
    .kpi-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .kpi-card {
      flex: 1;
      padding: 20px;
      background: var(--card-bg);
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      text-align: center;
    }
    .kpi-card h3 {
      margin: 0; font-size: 1rem; color: #555;
    }
    .kpi-card p {
      margin: 10px 0 0; font-size: 1.5rem; font-weight: bold; color: var(--primary-color);
    }
    .results-container table {
      width: 100%;
      border-collapse: collapse;
    }
    .results-container th, .results-container td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    .results-container th {
      background-color: var(--primary-color);
      color: white;
    }
    .results-container .parent-row {
        cursor: pointer;
        font-weight: bold;
        background-color: #f2f2f2;
    }
    .results-container .parent-row:hover {
        background-color: #e0e0e0;
    }
    .results-container .child-row {
        display: none; /* Hidden by default */
        background-color: #fafafa;
    }
    .insights-container {
        margin-top: 20px;
        padding: 20px;
        background-color: #eef2f7;
        border-radius: 8px;
    }
    .insights-container h3 {
        margin-top: 0;
        color: var(--primary-color);
    }

    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .btn-primary:hover {
        background-color: #16a085; /* Darker Teal */
        border-color: #16a085;
    }
  </style>
</head>
<body>
  <div class="sidebar">
      <h1 class="logo">SMS Pro</h1>
      <p class="subtitle">Site Management Suite</p>
      <nav class="menu">
            <a href="admin-dashboard.html"><i class="fa-solid fa-tachometer-alt"></i> <span>Dashboard</span></a>
            <a href="site-details.html"><i class="fa-solid fa-plus"></i> <span>Create a Site</span></a>
            <a href="boq-detail.html"><i class="fa-solid fa-list-check"></i> <span>Enter BOQ Details</span></a>
            <a href="budget-details.html"><i class="fa-solid fa-coins"></i> <span>Enter Budget Details</span></a>
            <a href="actual-details.html"><i class="fa-solid fa-chart-line"></i> <span>Enter Actual Details</span></a>
            <a href="view-site.html" class="active"><i class="fa-solid fa-eye"></i> <span>View Sites</span></a>
            <a href="documentation.html"><i class="fa-solid fa-book"></i> <span>Documentation</span></a>
            <a href="expense-form.html"><i class="fa-solid fa-file-invoice-dollar"></i> <span>Expense Form</span></a>
            <a href="expense-details.html"><i class="fa-solid fa-money-check-dollar"></i> <span>Expense Details</span></a>
            <a href="site_completion_details.html"><i class="fa-solid fa-flag-checkered"></i> <span>Site Completion</span></a>
            <a href="icr_1&_icr2_details.html"><i class="fa-solid fa-file-signature"></i> <span>ICR Details</span></a>
            <a href="invoices.html"><i class="fa-solid fa-file-signature"></i> <span>Invoices</span></a>
            <a href="payment-details.html"><i class="fa-solid fa-money-bill-wave"></i> <span>Payment Details</span></a>
            <a href="stock-details.html"><i class="fa-solid fa-boxes-stacked"></i> <span>Stock Details</span></a>
            <a href="site-progress.html"><i class="fa-solid fa-chart-simple"></i> <span>Site Progress</span></a>
            <a href="design-management.html"><i class="fa-solid fa-ruler-combined"></i> <span>Design Management</span></a>
        </nav>
  </div>

  <div class="main-content">
    <h1>View Site Details</h1>

    <label for="siteSelect">Select Site:</label>
    <select id="siteSelect" class="form-select">
      <option value="">-- Select a Site --</option>
    </select>

    <div id="siteDetails" style="margin-top: 20px;"></div>
    <div style="margin-top: 10px;">
      <button id="saveChangesBtn" class="btn btn-primary" style="display:none;">üíæ Save Changes</button>
    </div>

    <!-- Comparison Section -->
    <div id="comparisonContainer" class="comparison-container">
      <h2>Comparison</h2>
      <div class="comparison-controls">
        <label for="comparisonSelect">Select Comparison:</label>
        <select id="comparisonSelect" class="form-select">
          <option value="">-- Select --</option>
          <option value="boq-budget">BOQ vs Budget</option>
          <option value="boq-expense">BOQ vs Expense</option>
          <option value="budget-expense">Budget vs Expense</option>
        </select>
      </div>
      <div id="kpiContainer" class="kpi-container">
        <!-- KPIs will be loaded here -->
      </div>
      <div id="resultsContainer" class="results-container">
        <!-- Comparison table will be loaded here -->
      </div>
      <div id="insightsContainer" class="insights-container">
          <!-- Insights will be loaded here -->
      </div>
    </div>
  </div>

  <script>
    const { createClient } = supabase;

    const supabaseClient = createClient(
      'https://mxktarizsqttwwzbqgld.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im14a3Rhcml6c3F0dHd3emJxZ2xkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2NDA3MTMsImV4cCI6MjA2ODIxNjcxM30.UKA9NjB8mlxYJjzaC0cMnPGREcEAf-NQ3AeRWNWeuP8'
    );

    const siteSelect = document.getElementById('siteSelect');
    const siteDetailsDiv = document.getElementById('siteDetails');
    const saveBtn = document.getElementById('saveChangesBtn');
    const comparisonContainer = document.getElementById('comparisonContainer');
    const comparisonSelect = document.getElementById('comparisonSelect');
    const kpiContainer = document.getElementById('kpiContainer');
    const resultsContainer = document.getElementById('resultsContainer');

    let currentData = {};
    let originalId = null;

    document.addEventListener('DOMContentLoaded', async () => {
      const { data, error } = await supabaseClient
        .from('site_details')
        .select('id, site_name')
        .order('site_name', { ascending: true });

      if (error) {
        alert('Error loading sites: ' + error.message);
        return;
      }

      data.forEach(site => {
        const option = document.createElement('option');
        option.value = site.id;
        option.textContent = site.site_name;
        siteSelect.appendChild(option);
      });
    });

    siteSelect.addEventListener('change', async (e) => {
      const siteId = e.target.value;
      siteDetailsDiv.innerHTML = '';
      saveBtn.style.display = 'none';
      currentData = {};
      originalId = null;
      comparisonContainer.style.display = 'none'; // Hide on change

      if (!siteId) return;

      // Show comparison container when a site is selected
      comparisonContainer.style.display = 'block';

      const { data, error } = await supabaseClient
        .from('site_details')
        .select('*')
        .eq('id', siteId)
        .single();

      if (error) {
        siteDetailsDiv.innerHTML = '<p style="color:red">Error fetching site details.</p>';
        return;
      }

      originalId = data.id;
      currentData = { ...data };

      const table = document.createElement('table');
      table.className = 'table table-bordered';

      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      Object.keys(data).forEach(key => {
        const th = document.createElement('th');
        th.textContent = key.replace(/_/g, ' ').toUpperCase();
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      const valueRow = document.createElement('tr');
      Object.keys(data).forEach(key => {
        let td;
        if (key !== 'id' && (key.endsWith('_date') || key === 'date')) {
          td = document.createElement('td');
          td.dataset.key = key;
          const dateInput = document.createElement('input');
          dateInput.type = 'date';
          dateInput.className = 'form-control';
          dateInput.value = data[key] ? data[key].slice(0, 10) : '';
          dateInput.addEventListener('input', () => {
            saveBtn.style.display = 'inline-block';
          });
          td.appendChild(dateInput);
        } else {
          td = document.createElement('td');
          td.contentEditable = key !== 'id';
          td.textContent = data[key] ?? '-';
          td.dataset.key = key;
          td.addEventListener('input', () => {
            saveBtn.style.display = 'inline-block';
          });
        }
        valueRow.appendChild(td);
      });
      tbody.appendChild(valueRow);
      table.appendChild(tbody);

      const container = document.createElement('div');
      container.className = 'table-responsive';
      container.appendChild(table);

      siteDetailsDiv.appendChild(container);
    });

    comparisonSelect.addEventListener('change', async (e) => {
      const comparisonType = e.target.value;
      const siteId = siteSelect.value;
      const siteName = siteSelect.options[siteSelect.selectedIndex].text;

      kpiContainer.innerHTML = '';
      resultsContainer.innerHTML = '';

      if (!comparisonType || !siteId) return;

      let data1, data2, expenseData;
      let label1 = '', label2 = '';

      if (comparisonType === 'boq-budget') {
        label1 = 'BOQ';
        label2 = 'Budget';
        const { data: boqData } = await supabaseClient.from('boq_details').select('*').eq('site_id', siteId);
        const { data: budgetData } = await supabaseClient.from('budget_details').select('*').eq('site_id', siteId);
        data1 = boqData;
        data2 = budgetData;
      } else if (comparisonType === 'boq-expense') {
        label1 = 'BOQ';
        label2 = 'Expense';
        const { data: boqData } = await supabaseClient.from('boq_details').select('*').eq('site_id', siteId);
        const { data: actualData } = await supabaseClient.from('actual_details').select('*').eq('site_id', siteId);
        const { data: expenseEntries } = await supabaseClient.from('expense_entries').select('*').eq('site', siteName);
        data1 = boqData;
        expenseData = { actual: actualData, expenses: expenseEntries };
        data2 = expenseData;
      } else if (comparisonType === 'budget-expense') {
        label1 = 'Budget';
        label2 = 'Expense';
        const { data: budgetData } = await supabaseClient.from('budget_details').select('*').eq('site_id', siteId);
        const { data: actualData } = await supabaseClient.from('actual_details').select('*').eq('site_id', siteId);
        const { data: expenseEntries } = await supabaseClient.from('expense_entries').select('*').eq('site', siteName);
        data1 = budgetData;
        expenseData = { actual: actualData, expenses: expenseEntries };
        data2 = expenseData;
      }

      displayComparison(data1, data2, label1, label2, comparisonType);
      generateInsights(data1, data2, label1, label2, comparisonType);
    });

    function displayComparison(data1, data2, label1, label2, comparisonType) {
      let total1, total2;
      let materialTotal = 0;
      let expenseTotal = 0;

      try {
        if (comparisonType.includes('expense')) {
          total1 = data1.reduce((sum, item) => sum + (item.total || 0), 0);
          
          if (data2.actual && Array.isArray(data2.actual)) {
            materialTotal = data2.actual.reduce((sum, item) => sum + (item.total || 0), 0);
          }
          
          if (data2.expenses && Array.isArray(data2.expenses)) {
            expenseTotal = data2.expenses.reduce((sum, item) => sum + (item.amount || 0), 0);
          }
          
          total2 = materialTotal + expenseTotal;
        } else {
          total1 = data1.reduce((sum, item) => sum + (item.total || 0), 0);
          total2 = data2.reduce((sum, item) => sum + (item.total || 0), 0);
        }

        kpiContainer.innerHTML = `
          <div class="kpi-card">
            <h3>Total ${label1}</h3>
            <p>Rs ${total1.toLocaleString()}</p>
          </div>
          <div class="kpi-card">
            <h3>Total ${label2}</h3>
              <p>Rs ${total2.toLocaleString()}</p>
              <small>Material: Rs ${materialTotal.toLocaleString()}<br>Service: Rs ${expenseTotal.toLocaleString()}</small>
            </div>
          <div class="kpi-card">
            <h3>Difference</h3>
            <p>Rs ${(total1 - total2).toLocaleString()}</p>
          </div>
        `;

        const groupedData = {};

        if (data1 && Array.isArray(data1)) {
          data1.forEach(item => {
            const itemType = item.item_type || 'N/A';
            if (!groupedData[itemType]) {
              groupedData[itemType] = {};
            }
            const key = item.item_description || 'N/A';
            if (!groupedData[itemType][key]) groupedData[itemType][key] = { val1: 0, val2: 0 };
            groupedData[itemType][key].val1 += item.total || 0;
          });
        }

        if (comparisonType.includes('expense')) {
          if (data2.actual && Array.isArray(data2.actual)) {
            data2.actual.forEach(item => {
              const itemType = 'Material';
              if (!groupedData[itemType]) {
                groupedData[itemType] = {};
              }
              const key = item.item_description || 'N/A';
              if (!groupedData[itemType][key]) groupedData[itemType][key] = { val1: 0, val2: 0 };
              groupedData[itemType][key].val2 += item.total || 0;
            });
          }
          
          if (data2.expenses && Array.isArray(data2.expenses)) {
            data2.expenses.forEach(item => {
              const itemType = 'Service Charges';
              if (!groupedData[itemType]) {
                groupedData[itemType] = {};
              }
              const key = item.item_description || 'N/A';
              if (!groupedData[itemType][key]) groupedData[itemType][key] = { val1: 0, val2: 0 };
              groupedData[itemType][key].val2 += item.amount || 0;
            });
          }
        } else {
          if (data2 && Array.isArray(data2)) {
            data2.forEach(item => {
              const itemType = item.item_type || 'N/A';
              if (!groupedData[itemType]) {
                groupedData[itemType] = {};
              }
              const key = item.item_description || 'N/A';
              if (!groupedData[itemType][key]) groupedData[itemType][key] = { val1: 0, val2: 0 };
              groupedData[itemType][key].val2 += item.total || 0;
            });
          }
        }

        let tableHTML = '<table class="table table-bordered table-hover"><thead><tr><th>Item Type / Description</th><th>' + label1 + '</th><th>' + label2 + '</th><th>Difference</th></tr></thead><tbody>';

        for (const itemType in groupedData) {
          let typeTotal1 = 0;
          let typeTotal2 = 0;
          for (const desc in groupedData[itemType]) {
            typeTotal1 += groupedData[itemType][desc].val1;
            typeTotal2 += groupedData[itemType][desc].val2;
          }

          tableHTML += `<tr class="parent-row" data-type="${itemType}"><td>${itemType}</td><td>${typeTotal1.toLocaleString()}</td><td>${typeTotal2.toLocaleString()}</td><td>${(typeTotal1 - typeTotal2).toLocaleString()}</td></tr>`;

          for (const desc in groupedData[itemType]) {
            const item = groupedData[itemType][desc];
            const diff = item.val1 - item.val2;
            tableHTML += `
              <tr class="child-row" data-parent-type="${itemType}">
                <td style="padding-left: 30px;">${desc}</td>
                <td>${item.val1.toLocaleString()}</td>
                <td>${item.val2.toLocaleString()}</td>
                <td>${diff.toLocaleString()}</td>
              </tr>
            `;
          }
        }

        tableHTML += '</tbody></table>';
        resultsContainer.innerHTML = tableHTML;

        resultsContainer.querySelectorAll('.parent-row').forEach(row => {
            row.addEventListener('click', () => {
                const type = row.dataset.type;
                resultsContainer.querySelectorAll(`.child-row[data-parent-type="${type}"]`).forEach(childRow => {
                    childRow.style.display = childRow.style.display === 'table-row' ? 'none' : 'table-row';
                });
            });
        });

      } catch (error) {
        console.error('Error in displayComparison:', error);
        resultsContainer.innerHTML = `<p>Error displaying comparison: ${error.message}</p>`;
      }
    }

    function generateInsights(data1, data2, label1, label2, comparisonType) {
        const insightsContainer = document.getElementById('insightsContainer');
        let total1 = 0, total2 = 0;

        try {
          if (comparisonType.includes('expense')) {
              if (data1 && Array.isArray(data1)) {
                total1 = data1.reduce((sum, item) => sum + (item.total || 0), 0);
              }
              
              const materialTotal = (data2.actual && Array.isArray(data2.actual)) ? 
                data2.actual.reduce((sum, item) => sum + (item.total || 0), 0) : 0;
              
              const expenseTotal = (data2.expenses && Array.isArray(data2.expenses)) ? 
                data2.expenses.reduce((sum, item) => sum + (item.amount || 0), 0) : 0;
              
              total2 = materialTotal + expenseTotal;
          } else {
              if (data1 && Array.isArray(data1)) {
                total1 = data1.reduce((sum, item) => sum + (item.total || 0), 0);
              }
              if (data2 && Array.isArray(data2)) {
                total2 = data2.reduce((sum, item) => sum + (item.total || 0), 0);
              }
          }

          const difference = total1 - total2;

          let insightsHTML = '<h3>Insights</h3>';
          if (difference > 0) {
              insightsHTML += `<p>The ${label1} is <strong>Rs ${difference.toLocaleString()}</strong> over the ${label2}.</p>`;
          } else if (difference < 0) {
              insightsHTML += `<p>The ${label1} is <strong>Rs ${(-difference).toLocaleString()}</strong> under the ${label2}.</p>`;
          } else {
              insightsHTML += `<p>The ${label1} and ${label2} are balanced.</p>`;
          }
          insightsContainer.innerHTML = insightsHTML;
          
        } catch (error) {
          console.error('Error in generateInsights:', error);
          insightsContainer.innerHTML = `<p>Error generating insights: ${error.message}</p>`;
        }
    }

    saveBtn.addEventListener('click', async () => {
      const cells = document.querySelectorAll('td[data-key]');
      let updates = {};

      cells.forEach(cell => {
        const key = cell.dataset.key;
        if (key !== 'id') {
          let value;
          if (cell.querySelector('input[type="date"]')) {
            // Date field
            value = cell.querySelector('input[type="date"]').value;
            value = value === '' ? null : value;
          } else {
            value = cell.textContent.trim();
            if (value === '-' || value === '') {
              value = null;
            } else if (!isNaN(value) && value !== null && value !== '') {
              value = Number(value);
            }
          }
          updates[key] = value;
        }
      });

      const { error } = await supabaseClient
        .from('site_details')
        .update(updates)
        .eq('id', originalId);

      if (error) {
        alert('‚ùå Error updating data: ' + error.message);
      } else {
        alert('‚úÖ Changes saved successfully!');
        saveBtn.style.display = 'none';
      }
    });
  </script>
</body>
</html>